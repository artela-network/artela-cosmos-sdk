<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-v0.50 plugin-docs plugin-id-default docs-doc-id-architecture/adr-040-storage-and-smt-state-commitments">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">ADR 040: Storage and SMT State Commitments | Cosmos SDK</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://docs.cosmos.network/img/banner.jpg"><meta data-rh="true" name="twitter:image" content="https://docs.cosmos.network/img/banner.jpg"><meta data-rh="true" property="og:url" content="https://docs.cosmos.network/v0.50/architecture/adr-040-storage-and-smt-state-commitments"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="v0.50"><meta data-rh="true" name="docusaurus_tag" content="docs-default-v0.50"><meta data-rh="true" name="docsearch:version" content="v0.50"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-v0.50"><meta data-rh="true" property="og:title" content="ADR 040: Storage and SMT State Commitments | Cosmos SDK"><meta data-rh="true" name="description" content="Changelog"><meta data-rh="true" property="og:description" content="Changelog"><link data-rh="true" rel="icon" href="/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://docs.cosmos.network/v0.50/architecture/adr-040-storage-and-smt-state-commitments"><link data-rh="true" rel="alternate" href="https://docs.cosmos.network/v0.50/architecture/adr-040-storage-and-smt-state-commitments" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.cosmos.network/v0.50/architecture/adr-040-storage-and-smt-state-commitments" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://QLS2QSP47E-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Cosmos SDK" href="/opensearch.xml">

<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51029217-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><link rel="stylesheet" href="/assets/css/styles.e98ee2b8.css">
<link rel="preload" href="/assets/js/runtime~main.375ada2f.js" as="script">
<link rel="preload" href="/assets/js/main.e8d6e5a5.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://docs.cosmos.network" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/logo-sdk.svg" alt="Cosmos SDK Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo-sdk.svg" alt="Cosmos SDK Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Cosmos SDK</b></a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/v0.50">v0.50</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/main/architecture/adr-040-storage-and-smt-state-commitments">Next</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/v0.50/architecture/adr-040-storage-and-smt-state-commitments">v0.50</a></li><li><a class="dropdown__link" href="/v0.47/architecture/adr-040-storage-and-smt-state-commitments">v0.47</a></li><li><a href="https://docs.cosmos.network/v0.46/" target="_self" rel="noopener noreferrer" class="dropdown__link">v0.46<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://docs.cosmos.network/v0.45/" target="_self" rel="noopener noreferrer" class="dropdown__link">v0.45<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://github.com/cosmos/cosmos-sdk" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="github-icon">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M12 0.300049C5.4 0.300049 0 5.70005 0 12.3001C0 17.6001 3.4 22.1001 8.2 23.7001C8.8 23.8001 9 23.4001 9 23.1001C9 22.8001 9 22.1001 9 21.1001C5.7 21.8001 5 19.5001 5 19.5001C4.5 18.1001 3.7 17.7001 3.7 17.7001C2.5 17.0001 3.7 17.0001 3.7 17.0001C4.9 17.1001 5.5 18.2001 5.5 18.2001C6.6 20.0001 8.3 19.5001 9 19.2001C9.1 18.4001 9.4 17.9001 9.8 17.6001C7.1 17.3001 4.3 16.3001 4.3 11.7001C4.3 10.4001 4.8 9.30005 5.5 8.50005C5.5 8.10005 5 6.90005 5.7 5.30005C5.7 5.30005 6.7 5.00005 9 6.50005C10 6.20005 11 6.10005 12 6.10005C13 6.10005 14 6.20005 15 6.50005C17.3 4.90005 18.3 5.30005 18.3 5.30005C19 7.00005 18.5 8.20005 18.4 8.50005C19.2 9.30005 19.6 10.4001 19.6 11.7001C19.6 16.3001 16.8 17.3001 14.1 17.6001C14.5 18.0001 14.9 18.7001 14.9 19.8001C14.9 21.4001 14.9 22.7001 14.9 23.1001C14.9 23.4001 15.1 23.8001 15.7 23.7001C20.5 22.1001 23.9 17.6001 23.9 12.3001C24 5.70005 18.6 0.300049 12 0.300049Z" fill="currentColor"/>
            </svg>
            </a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/v0.50">Cosmos SDK Documentation</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v0.50/intro/overview">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v0.50/basics/app-anatomy">Basics</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v0.50/core/baseapp">Core Concepts</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v0.50/building-modules/intro">Building Modules</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v0.50/building-apps/app-go">Building Apps</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v0.50/run-node/keyring">Running a Node, API and CLI</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v0.50/migrations/intro">SDK Migrations</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v0.50/modules">SDK Modules</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v0.50/packages">Packages</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v0.50/tooling">Tooling</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/v0.50/architecture">ADRs</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture">Architecture Decision Records (ADR)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/PROCESS">ADR Creation Process</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-002-docs-structure">ADR 002: SDK Documentation Structure</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-003-dynamic-capability-store">ADR 3: Dynamic Capability Store</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-004-split-denomination-keys">ADR 004: Split Denomination Keys</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-006-secret-store-replacement">ADR 006: Secret Store Replacement</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-007-specialization-groups">ADR 007: Specialization Groups</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-008-dCERT-group">ADR 008: Decentralized Computer Emergency Response Team (dCERT) Group</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-009-evidence-module">ADR 009: Evidence Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-010-modular-antehandler">ADR 010: Modular AnteHandler</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-011-generalize-genesis-accounts">ADR 011: Generalize Genesis Accounts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-012-state-accessors">ADR 012: State Accessors</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-013-metrics">ADR 013: Observability</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-014-proportional-slashing">ADR 14: Proportional Slashing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-016-validator-consensus-key-rotation">ADR 016: Validator Consensus Key Rotation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-017-historical-header-module">ADR 17: Historical Header Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-018-extendable-voting-period">ADR 18: Extendable Voting Periods</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-019-protobuf-state-encoding">ADR 019: Protocol Buffer State Encoding</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-020-protobuf-transaction-encoding">ADR 020: Protocol Buffer Transaction Encoding</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-021-protobuf-query-encoding">ADR 021: Protocol Buffer Query Encoding</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-022-custom-panic-handling">ADR 022: Custom BaseApp panic handling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-023-protobuf-naming">ADR 023: Protocol Buffer Naming and Versioning Conventions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-024-coin-metadata">ADR 024: Coin Metadata</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-027-deterministic-protobuf-serialization">ADR 027: Deterministic Protobuf Serialization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-028-public-key-addresses">ADR 028: Public Key Addresses</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-029-fee-grant-module">ADR 029: Fee Grant Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-030-authz-module">ADR 030: Authorization Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-031-msg-service">ADR 031: Protobuf Msg Services</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-032-typed-events">ADR 032: Typed Events</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-033-protobuf-inter-module-comm">ADR 033: Protobuf-based Inter-Module Communication</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-034-account-rekeying">ADR 034: Account Rekeying</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-035-rosetta-api-support">ADR 035: Rosetta API Support</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-036-arbitrary-signature">ADR 036: Arbitrary Message Signature Specification</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-037-gov-split-vote">ADR 037: Governance split votes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-038-state-listening">ADR 038: KVStore state listening</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-039-epoched-staking">ADR 039: Epoched Staking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/v0.50/architecture/adr-040-storage-and-smt-state-commitments">ADR 040: Storage and SMT State Commitments</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-041-in-place-store-migrations">ADR 041: In-Place Store Migrations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-042-group-module">ADR 042: Group Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-043-nft-module">ADR 43: NFT Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-044-protobuf-updates-guidelines">ADR 044: Guidelines for Updating Protobuf Definitions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-045-check-delivertx-middlewares">ADR 045: BaseApp {Check,Deliver}Tx as Middlewares</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-046-module-params">ADR 046: Module Params</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-047-extend-upgrade-plan">ADR 047: Extend Upgrade Plan</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-048-consensus-fees">ADR 048: Multi Tire Gas Price System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-049-state-sync-hooks">ADR 049: State Sync Hooks</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-050-sign-mode-textual-annex1">ADR 050: SIGN_MODE_TEXTUAL: Annex 1 Value Renderers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-050-sign-mode-textual-annex2">ADR 050: SIGN_MODE_TEXTUAL: Annex 2 XXX</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-050-sign-mode-textual">ADR 050: SIGN_MODE_TEXTUAL</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-053-go-module-refactoring">ADR 053: Go Module Refactoring</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-054-semver-compatible-modules">ADR 054: Semver Compatible SDK Modules</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-055-orm">ADR 055: ORM</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-057-app-wiring">ADR 057: App Wiring</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-058-auto-generated-cli">ADR 058: Auto-Generated CLI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-059-test-scopes">ADR 059: Test Scopes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-060-abci-1.0">ADR 60: ABCI 1.0 Integration (Phase I)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-061-liquid-staking">ADR ADR-061: Liquid Staking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-062-collections-state-layer">ADR 062: Collections, a simplified storage layer for cosmos-sdk modules.</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-063-core-module-api">ADR 063: Core Module API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-064-abci-2.0">ADR 64: ABCI 2.0 Integration (Phase II)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-065-store-v2">ADR-065: Store V2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/v0.50/architecture/adr-template">ADR {ADR-NUMBER}:</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v0.50/rfc">RFCs</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/v0.50/spec">Specifications</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a href="https://tutorials.cosmos.network" target="_blank" rel="noopener noreferrer" class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true">Resources</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a href="https://tutorials.cosmos.network" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_NmtK" tabindex="0">Tutorials<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a href="https://pkg.go.dev/github.com/cosmos/cosmos-sdk" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_NmtK" tabindex="0">SDK API Reference<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a href="https://docs.cosmos.network/swagger/" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_NmtK" tabindex="0">REST API Spec<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a href="https://github.com/cosmos/awesome-cosmos" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_NmtK" tabindex="0">Awesome Cosmos<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a href="https://github.com/orgs/cosmos/discussions" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_NmtK" tabindex="0">Support<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is unreleased documentation for <!-- -->Cosmos SDK<!-- --> <b>v0.50</b> version.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/v0.47/architecture/adr-040-storage-and-smt-state-commitments">latest version</a></b> (<!-- -->v0.47<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><span class="breadcrumbs__link">ADRs</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">ADR 040: Storage and SMT State Commitments</span><meta itemprop="position" content="2"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: v0.50</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>ADR 040: Storage and SMT State Commitments</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="changelog">Changelog<a href="#changelog" class="hash-link" aria-label="Direct link to Changelog" title="Direct link to Changelog">​</a></h2><ul><li>2020-01-15: Draft</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a href="#status" class="hash-link" aria-label="Direct link to Status" title="Direct link to Status">​</a></h2><p>DRAFT Not Implemented</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="abstract">Abstract<a href="#abstract" class="hash-link" aria-label="Direct link to Abstract" title="Direct link to Abstract">​</a></h2><p>Sparse Merkle Tree (<a href="https://osf.io/8mcnh/" target="_blank" rel="noopener noreferrer">SMT</a>) is a version of a Merkle Tree with various storage and performance optimizations. This ADR defines a separation of state commitments from data storage and the Cosmos SDK transition from IAVL to SMT.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2><p>Currently, Cosmos SDK uses IAVL for both state <a href="https://cryptography.fandom.com/wiki/Commitment_scheme" target="_blank" rel="noopener noreferrer">commitments</a> and data storage.</p><p>IAVL has effectively become an orphaned project within the Cosmos ecosystem and it&#x27;s proven to be an inefficient state commitment data structure.
In the current design, IAVL is used for both data storage and as a Merkle Tree for state commitments. IAVL is meant to be a standalone Merkelized key/value database, however it&#x27;s using a KV DB engine to store all tree nodes. So, each node is stored in a separate record in the KV DB. This causes many inefficiencies and problems:</p><ul><li>Each object query requires a tree traversal from the root. Subsequent queries for the same object are cached on the Cosmos SDK level.</li><li>Each edge traversal requires a DB query.</li><li>Creating snapshots is <a href="https://github.com/cosmos/cosmos-sdk/issues/7215#issuecomment-684804950" target="_blank" rel="noopener noreferrer">expensive</a>. It takes about 30 seconds to export less than 100 MB of state (as of March 2020).</li><li>Updates in IAVL may trigger tree reorganization and possible O(log(n)) hashes re-computation, which can become a CPU bottleneck.</li><li>The node structure is pretty expensive - it contains a standard tree node elements (key, value, left and right element) and additional metadata such as height, version (which is not required by the Cosmos SDK). The entire node is hashed, and that hash is used as the key in the underlying database, <a href="https://github.com/cosmos/iavl/blob/master/docs/node/node.md" target="_blank" rel="noopener noreferrer">ref</a>.</li></ul><p>Moreover, the IAVL project lacks support and a maintainer and we already see better and well-established alternatives. Instead of optimizing the IAVL, we are looking into other solutions for both storage and state commitments.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a href="#decision" class="hash-link" aria-label="Direct link to Decision" title="Direct link to Decision">​</a></h2><p>We propose to separate the concerns of state commitment (<strong>SC</strong>), needed for consensus, and state storage (<strong>SS</strong>), needed for state machine. Finally we replace IAVL with <a href="https://github.com/lazyledger/smt" target="_blank" rel="noopener noreferrer">Celestia&#x27;s SMT</a>. Celestia SMT is based on Diem (called jellyfish) design <!-- -->[*]<!-- --> - it uses a compute-optimised SMT by replacing subtrees with only default values with a single node (same approach is used by Ethereum2) and implements compact proofs.</p><p>The storage model presented here doesn&#x27;t deal with data structure nor serialization. It&#x27;s a Key-Value database, where both key and value are binaries. The storage user is responsible for data serialization.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="decouple-state-commitment-from-storage">Decouple state commitment from storage<a href="#decouple-state-commitment-from-storage" class="hash-link" aria-label="Direct link to Decouple state commitment from storage" title="Direct link to Decouple state commitment from storage">​</a></h3><p>Separation of storage and commitment (by the SMT) will allow the optimization of different components according to their usage and access patterns.</p><p><code>SC</code> (SMT) is used to commit to a data and compute Merkle proofs. <code>SS</code> is used to directly access data. To avoid collisions, both <code>SS</code> and <code>SC</code> will use a separate storage namespace (they could use the same database underneath). <code>SS</code> will store each record directly (mapping <code>(key, value)</code> as <code>key → value</code>).</p><p>SMT is a merkle tree structure: we don&#x27;t store keys directly. For every <code>(key, value)</code> pair, <code>hash(key)</code> is used as leaf path (we hash a key to uniformly distribute leaves in the tree) and <code>hash(value)</code> as the leaf contents. The tree structure is specified in more depth <a href="#smt-for-state-commitment">below</a>.</p><p>For data access we propose 2 additional KV buckets (implemented as namespaces for the key-value pairs, sometimes called <a href="https://github.com/facebook/rocksdb/wiki/Terminology" target="_blank" rel="noopener noreferrer">column family</a>):</p><ol><li>B1: <code>key → value</code>: the principal object storage, used by a state machine, behind the Cosmos SDK <code>KVStore</code> interface: provides direct access by key and allows prefix iteration (KV DB backend must support it).</li><li>B2: <code>hash(key) → key</code>: a reverse index to get a key from an SMT path. Internally the SMT will store <code>(key, value)</code> as <code>prefix || hash(key) || hash(value)</code>. So, we can get an object value by composing <code>hash(key) → B2 → B1</code>.</li><li>We could use more buckets to optimize the app usage if needed.</li></ol><p>We propose to use a KV database for both <code>SS</code> and <code>SC</code>. The store interface will allow to use the same physical DB backend for both <code>SS</code> and <code>SC</code> as well two separate DBs. The latter option allows for the separation of <code>SS</code> and <code>SC</code> into different hardware units, providing support for more complex setup scenarios and improving overall performance: one can use different backends (eg RocksDB and Badger) as well as independently tuning the underlying DB configuration.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="requirements">Requirements<a href="#requirements" class="hash-link" aria-label="Direct link to Requirements" title="Direct link to Requirements">​</a></h3><p>State Storage requirements:</p><ul><li>range queries</li><li>quick (key, value) access</li><li>creating a snapshot</li><li>historical versioning</li><li>pruning (garbage collection)</li></ul><p>State Commitment requirements:</p><ul><li>fast updates</li><li>tree path should be short</li><li>query historical commitment proofs using ICS-23 standard</li><li>pruning (garbage collection)</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="smt-for-state-commitment">SMT for State Commitment<a href="#smt-for-state-commitment" class="hash-link" aria-label="Direct link to SMT for State Commitment" title="Direct link to SMT for State Commitment">​</a></h3><p>A Sparse Merkle tree is based on the idea of a complete Merkle tree of an intractable size. The assumption here is that as the size of the tree is intractable, there would only be a few leaf nodes with valid data blocks relative to the tree size, rendering a sparse tree.</p><p>The full specification can be found at <a href="https://github.com/celestiaorg/celestia-specs/blob/ec98170398dfc6394423ee79b00b71038879e211/src/specs/data_structures.md#sparse-merkle-tree" target="_blank" rel="noopener noreferrer">Celestia</a>. In summary:</p><ul><li>The SMT consists of a binary Merkle tree, constructed in the same fashion as described in <a href="https://tools.ietf.org/html/rfc6962" target="_blank" rel="noopener noreferrer">Certificate Transparency (RFC-6962)</a>, but using as the hashing function SHA-2-256 as defined in <a href="https://doi.org/10.6028/NIST.FIPS.180-4" target="_blank" rel="noopener noreferrer">FIPS 180-4</a>.</li><li>Leaves and internal nodes are hashed differently: the one-byte <code>0x00</code> is prepended for leaf nodes while <code>0x01</code> is prepended for internal nodes.</li><li>Default values are given to leaf nodes with empty leaves.</li><li>While the above rule is sufficient to pre-compute the values of intermediate nodes that are roots of empty subtrees, a further simplification is to extend this default value to all nodes that are roots of empty subtrees. The 32-byte zero is used as the default value. This rule takes precedence over the above one.</li><li>An internal node that is the root of a subtree that contains exactly one non-empty leaf is replaced by that leaf&#x27;s leaf node.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="snapshots-for-storage-sync-and-state-versioning">Snapshots for storage sync and state versioning<a href="#snapshots-for-storage-sync-and-state-versioning" class="hash-link" aria-label="Direct link to Snapshots for storage sync and state versioning" title="Direct link to Snapshots for storage sync and state versioning">​</a></h3><p>Below, with simple <em>snapshot</em> we refer to a database snapshot mechanism, not to a <em>ABCI snapshot sync</em>. The latter will be referred as <em>snapshot sync</em> (which will directly use DB snapshot as described below).</p><p>Database snapshot is a view of DB state at a certain time or transaction. It&#x27;s not a full copy of a database (it would be too big). Usually a snapshot mechanism is based on a <em>copy on write</em> and it allows DB state to be efficiently delivered at a certain stage.
Some DB engines support snapshotting. Hence, we propose to reuse that functionality for the state sync and versioning (described below). We limit the supported DB engines to ones which efficiently implement snapshots. In a final section we discuss the evaluated DBs.</p><p>One of the Stargate core features is a <em>snapshot sync</em> delivered in the <code>/snapshot</code> package. It provides a way to trustlessly sync a blockchain without repeating all transactions from the genesis. This feature is implemented in Cosmos SDK and requires storage support. Currently IAVL is the only supported backend. It works by streaming to a client a snapshot of a <code>SS</code> at a certain version together with a header chain.</p><p>A new database snapshot will be created in every <code>EndBlocker</code> and identified by a block height. The <code>root</code> store keeps track of the available snapshots to offer <code>SS</code> at a certain version. The <code>root</code> store implements the <code>RootStore</code> interface described below. In essence, <code>RootStore</code> encapsulates a <code>Committer</code> interface. <code>Committer</code> has a <code>Commit</code>, <code>SetPruning</code>, <code>GetPruning</code> functions which will be used for creating and removing snapshots. The <code>rootStore.Commit</code> function creates a new snapshot and increments the version on each call, and checks if it needs to remove old versions. We will need to update the SMT interface to implement the <code>Committer</code> interface.
NOTE: <code>Commit</code> must be called exactly once per block. Otherwise we risk going out of sync for the version number and block height.
NOTE: For the Cosmos SDK storage, we may consider splitting that interface into <code>Committer</code> and <code>PruningCommitter</code> - only the multiroot should implement <code>PruningCommitter</code> (cache and prefix store don&#x27;t need pruning).</p><p>Number of historical versions for <code>abci.RequestQuery</code> and state sync snapshots is part of a node configuration, not a chain configuration (configuration implied by the blockchain consensus). A configuration should allow to specify number of past blocks and number of past blocks modulo some number (eg: 100 past blocks and one snapshot every 100 blocks for past 2000 blocks). Archival nodes can keep all past versions.</p><p>Pruning old snapshots is effectively done by a database. Whenever we update a record in <code>SC</code>, SMT won&#x27;t update nodes - instead it creates new nodes on the update path, without removing the old one. Since we are snapshotting each block, we need to change that mechanism to immediately remove orphaned nodes from the database. This is a safe operation - snapshots will keep track of the records and make it available when accessing past versions.</p><p>To manage the active snapshots we will either use a DB <em>max number of snapshots</em> option (if available), or we will remove DB snapshots in the <code>EndBlocker</code>. The latter option can be done efficiently by identifying snapshots with block height and calling a store function to remove past versions.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="accessing-old-state-versions">Accessing old state versions<a href="#accessing-old-state-versions" class="hash-link" aria-label="Direct link to Accessing old state versions" title="Direct link to Accessing old state versions">​</a></h4><p>One of the functional requirements is to access old state. This is done through <code>abci.RequestQuery</code> structure.  The version is specified by a block height (so we query for an object by a key <code>K</code> at block height <code>H</code>). The number of old versions supported for <code>abci.RequestQuery</code> is configurable. Accessing an old state is done by using available snapshots.
<code>abci.RequestQuery</code> doesn&#x27;t need old state of <code>SC</code> unless the <code>prove=true</code> parameter is set. The SMT merkle proof must be included in the <code>abci.ResponseQuery</code> only if both <code>SC</code> and <code>SS</code> have a snapshot for requested version.</p><p>Moreover, Cosmos SDK could provide a way to directly access a historical state. However, a state machine shouldn&#x27;t do that - since the number of snapshots is configurable, it would lead to nondeterministic execution.</p><p>We positively <a href="https://github.com/cosmos/cosmos-sdk/discussions/8297" target="_blank" rel="noopener noreferrer">validated</a> a versioning and snapshot mechanism for querying old state with regards to the database we evaluated.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="state-proofs">State Proofs<a href="#state-proofs" class="hash-link" aria-label="Direct link to State Proofs" title="Direct link to State Proofs">​</a></h3><p>For any object stored in State Store (SS), we have corresponding object in <code>SC</code>. A proof for object <code>V</code> identified by a key <code>K</code> is a branch of <code>SC</code>, where the path corresponds to the key <code>hash(K)</code>, and the leaf is <code>hash(K, V)</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rollbacks">Rollbacks<a href="#rollbacks" class="hash-link" aria-label="Direct link to Rollbacks" title="Direct link to Rollbacks">​</a></h3><p>We need to be able to process transactions and roll-back state updates if a transaction fails. This can be done in the following way: during transaction processing, we keep all state change requests (writes) in a <code>CacheWrapper</code> abstraction (as it&#x27;s done today). Once we finish the block processing, in the <code>Endblocker</code>,  we commit a root store - at that time, all changes are written to the SMT and to the <code>SS</code> and a snapshot is created.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="committing-to-an-object-without-saving-it">Committing to an object without saving it<a href="#committing-to-an-object-without-saving-it" class="hash-link" aria-label="Direct link to Committing to an object without saving it" title="Direct link to Committing to an object without saving it">​</a></h3><p>We identified use-cases, where modules will need to save an object commitment without storing an object itself. Sometimes clients are receiving complex objects, and they have no way to prove a correctness of that object without knowing the storage layout. For those use cases it would be easier to commit to the object without storing it directly.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="refactor-multistore">Refactor MultiStore<a href="#refactor-multistore" class="hash-link" aria-label="Direct link to Refactor MultiStore" title="Direct link to Refactor MultiStore">​</a></h3><p>The Stargate <code>/store</code> implementation (store/v1) adds an additional layer in the SDK store construction - the <code>MultiStore</code> structure. The multistore exists to support the modularity of the Cosmos SDK - each module is using its own instance of IAVL, but in the current implementation, all instances share the same database. The latter indicates, however, that the implementation doesn&#x27;t provide true modularity. Instead it causes problems related to race condition and atomic DB commits (see: <a href="https://github.com/cosmos/cosmos-sdk/issues/6370" target="_blank" rel="noopener noreferrer">#<!-- -->6370</a> and <a href="https://github.com/cosmos/cosmos-sdk/discussions/8297#discussioncomment-757043" target="_blank" rel="noopener noreferrer">discussion</a>).</p><p>We propose to reduce the multistore concept from the SDK, and to use a single instance of <code>SC</code> and <code>SS</code> in a <code>RootStore</code> object. To avoid confusion, we should rename the <code>MultiStore</code> interface to <code>RootStore</code>. The <code>RootStore</code> will have the following interface; the methods for configuring tracing and listeners are omitted for brevity.</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Used where read-only access to versions is needed.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> BasicRootStore </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Store</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">GetKVStore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">StoreKey</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> KVStore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CacheRootStore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> CacheRootStore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Used as the main app state, replacing CommitMultiStore.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> CommitRootStore </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BasicRootStore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Committer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Snapshotter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">GetVersion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">uint64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BasicRootStore</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">SetInitialVersion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">uint64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Trace and Listen methods</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Replaces CacheMultiStore for branched state.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> CacheRootStore </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BasicRootStore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Trace and Listen methods</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Example of constructor parameters for the concrete type.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> RootStoreConfig </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Upgrades        </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">StoreUpgrades</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    InitialVersion  </span><span class="token builtin">uint64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ReservePrefix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">StoreKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> StoreType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In contrast to <code>MultiStore</code>, <code>RootStore</code> doesn&#x27;t allow to dynamically mount sub-stores or provide an arbitrary backing DB for individual sub-stores.</p><p>NOTE: modules will be able to use a special commitment and their own DBs. For example: a module which will use ZK proofs for state can store and commit this proof in the <code>RootStore</code> (usually as a single record) and manage the specialized store privately or using the <code>SC</code> low level interface.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="compatibility-support">Compatibility support<a href="#compatibility-support" class="hash-link" aria-label="Direct link to Compatibility support" title="Direct link to Compatibility support">​</a></h4><p>To ease the transition to this new interface for users, we can create a shim which wraps a <code>CommitMultiStore</code> but provides a <code>CommitRootStore</code> interface, and expose functions to safely create and access the underlying <code>CommitMultiStore</code>.</p><p>The new <code>RootStore</code> and supporting types can be implemented in a <code>store/v2alpha1</code> package to avoid breaking existing code.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="merkle-proofs-and-ibc">Merkle Proofs and IBC<a href="#merkle-proofs-and-ibc" class="hash-link" aria-label="Direct link to Merkle Proofs and IBC" title="Direct link to Merkle Proofs and IBC">​</a></h4><p>Currently, an IBC (v1.0) Merkle proof path consists of two elements (<code>[&quot;&lt;store-key&gt;&quot;, &quot;&lt;record-key&gt;&quot;]</code>), with each key corresponding to a separate proof. These are each verified according to individual <a href="https://github.com/cosmos/ibc-go/blob/f7051429e1cf833a6f65d51e6c3df1609290a549/modules/core/23-commitment/types/merkle.go#L17" target="_blank" rel="noopener noreferrer">ICS-23 specs</a>, and the result hash of each step is used as the committed value of the next step, until a root commitment hash is obtained.
The root hash of the proof for <code>&quot;&lt;record-key&gt;&quot;</code> is hashed with the <code>&quot;&lt;store-key&gt;&quot;</code> to validate against the App Hash.</p><p>This is not compatible with the <code>RootStore</code>, which stores all records in a single Merkle tree structure, and won&#x27;t produce separate proofs for the store- and record-key. Ideally, the store-key component of the proof could just be omitted, and updated to use a &quot;no-op&quot; spec, so only the record-key is used. However, because the IBC verification code hardcodes the <code>&quot;ibc&quot;</code> prefix and applies it to the SDK proof as a separate element of the proof path, this isn&#x27;t possible without a breaking change. Breaking this behavior would severely impact the Cosmos ecosystem which already widely adopts the IBC module. Requesting an update of the IBC module across the chains is a time consuming effort and not easily feasible.</p><p>As a workaround, the <code>RootStore</code> will have to use two separate SMTs (they could use the same underlying DB): one for IBC state and one for everything else. A simple Merkle map that reference these SMTs will act as a Merkle Tree to create a final App hash. The Merkle map is not stored in a DBs - it&#x27;s constructed in the runtime. The IBC substore key must be <code>&quot;ibc&quot;</code>.</p><p>The workaround can still guarantee atomic syncs: the <a href="#evaluated-kv-databases">proposed DB backends</a> support atomic transactions and efficient rollbacks, which will be used in the commit phase.</p><p>The presented workaround can be used until the IBC module is fully upgraded to supports single-element commitment proofs.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="optimization-compress-module-key-prefixes">Optimization: compress module key prefixes<a href="#optimization-compress-module-key-prefixes" class="hash-link" aria-label="Direct link to Optimization: compress module key prefixes" title="Direct link to Optimization: compress module key prefixes">​</a></h3><p>We consider a compression of prefix keys by creating a mapping from module key to an integer, and serializing the integer using varint coding. Varint coding assures that different values don&#x27;t have common byte prefix. For Merkle Proofs we can&#x27;t use prefix compression - so it should only apply for the <code>SS</code> keys. Moreover, the prefix compression should be only applied for the module namespace. More precisely:</p><ul><li>each module has it&#x27;s own namespace;</li><li>when accessing a module namespace we create a KVStore with embedded prefix;</li><li>that prefix will be compressed only when accessing and managing <code>SS</code>.</li></ul><p>We need to assure that the codes won&#x27;t change. We can fix the mapping in a static variable (provided by an app) or SS state under a special key.</p><p>TODO: need to make decision about the key compression.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="optimization-ss-key-compression">Optimization: SS key compression<a href="#optimization-ss-key-compression" class="hash-link" aria-label="Direct link to Optimization: SS key compression" title="Direct link to Optimization: SS key compression">​</a></h2><p>Some objects may be saved with key, which contains a Protobuf message type. Such keys are long. We could save a lot of space if we can map Protobuf message types in varints.</p><p>TODO: finalize this or move to another ADR.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="migration">Migration<a href="#migration" class="hash-link" aria-label="Direct link to Migration" title="Direct link to Migration">​</a></h2><p>Using the new store will require a migration. 2 Migrations are proposed:</p><ol><li>Genesis export -- it will reset the blockchain history.</li><li>In place migration: we can reuse <code>UpgradeKeeper.SetUpgradeHandler</code> to provide the migration logic:</li></ol><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UpgradeKeeper</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetUpgradeHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;adr-40&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx sdk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> plan upgradetypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Plan</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vm module</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VersionMap</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">module</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VersionMap</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storev2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Migrate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">iavlstore</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">store</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// RunMigrations returns the VersionMap</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// with the updated module ConsensusVersions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RunMigrations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vm</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>Migrate</code> function will read all entries from a store/v1 DB and save them to the AD-40 combined KV store.
Cache layer should not be used and the operation must finish with a single Commit call.</p><p>Inserting records to the <code>SC</code> (SMT) component is the bottleneck. Unfortunately SMT doesn&#x27;t support batch transactions.
Adding batch transactions to <code>SC</code> layer is considered as a feature after the main release.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="Direct link to Consequences" title="Direct link to Consequences">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="backwards-compatibility">Backwards Compatibility<a href="#backwards-compatibility" class="hash-link" aria-label="Direct link to Backwards Compatibility" title="Direct link to Backwards Compatibility">​</a></h3><p>This ADR doesn&#x27;t introduce any Cosmos SDK level API changes.</p><p>We change the storage layout of the state machine, a storage hard fork and network upgrade is required to incorporate these changes. SMT provides a merkle proof functionality, however it is not compatible with ICS23. Updating the proofs for ICS23 compatibility is required.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="positive">Positive<a href="#positive" class="hash-link" aria-label="Direct link to Positive" title="Direct link to Positive">​</a></h3><ul><li>Decoupling state from state commitment introduce better engineering opportunities for further optimizations and better storage patterns.</li><li>Performance improvements.</li><li>Joining SMT based camp which has wider and proven adoption than IAVL. Example projects which decided on SMT: Ethereum2, Diem (Libra), Trillan, Tezos, Celestia.</li><li>Multistore removal fixes a longstanding issue with the current MultiStore design.</li><li>Simplifies merkle proofs - all modules, except IBC, have only one pass for merkle proof.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="negative">Negative<a href="#negative" class="hash-link" aria-label="Direct link to Negative" title="Direct link to Negative">​</a></h3><ul><li>Storage migration</li><li>LL SMT doesn&#x27;t support pruning - we will need to add and test that functionality.</li><li><code>SS</code> keys will have an overhead of a key prefix. This doesn&#x27;t impact <code>SC</code> because all keys in <code>SC</code> have same size (they are hashed).</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="neutral">Neutral<a href="#neutral" class="hash-link" aria-label="Direct link to Neutral" title="Direct link to Neutral">​</a></h3><ul><li>Deprecating IAVL, which is one of the core proposals of Cosmos Whitepaper.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="alternative-designs">Alternative designs<a href="#alternative-designs" class="hash-link" aria-label="Direct link to Alternative designs" title="Direct link to Alternative designs">​</a></h2><p>Most of the alternative designs were evaluated in <a href="https://paper.dropbox.com/published/State-commitments-and-storage-review--BDvA1MLwRtOx55KRihJ5xxLbBw-KeEB7eOd11pNrZvVtqUgL3h" target="_blank" rel="noopener noreferrer">state commitments and storage report</a>.</p><p>Ethereum research published <a href="https://dankradfeist.de/ethereum/2021/06/18/verkle-trie-for-eth1.html" target="_blank" rel="noopener noreferrer">Verkle Trie</a> - an idea of combining polynomial commitments with merkle tree in order to reduce the tree height. This concept has a very good potential, but we think it&#x27;s too early to implement it. The current, SMT based design could be easily updated to the Verkle Trie once other research implement all necessary libraries. The main advantage of the design described in this ADR is the separation of state commitments from the data storage and designing a more powerful interface.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="further-discussions">Further Discussions<a href="#further-discussions" class="hash-link" aria-label="Direct link to Further Discussions" title="Direct link to Further Discussions">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="evaluated-kv-databases">Evaluated KV Databases<a href="#evaluated-kv-databases" class="hash-link" aria-label="Direct link to Evaluated KV Databases" title="Direct link to Evaluated KV Databases">​</a></h3><p>We verified existing databases KV databases for evaluating snapshot support. The following databases provide efficient snapshot mechanism: Badger, RocksDB, <a href="https://github.com/cockroachdb/pebble" target="_blank" rel="noopener noreferrer">Pebble</a>. Databases which don&#x27;t provide such support or are not production ready: boltdb, leveldb, goleveldb, membdb, lmdb.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rdbms">RDBMS<a href="#rdbms" class="hash-link" aria-label="Direct link to RDBMS" title="Direct link to RDBMS">​</a></h3><p>Use of RDBMS instead of simple KV store for state. Use of RDBMS will require a Cosmos SDK API breaking change (<code>KVStore</code> interface) and will allow better data extraction and indexing solutions. Instead of saving an object as a single blob of bytes, we could save it as record in a table in the state storage layer, and as a <code>hash(key, protobuf(object))</code> in the SMT as outlined above. To verify that an object registered in RDBMS is same as the one committed to SMT, one will need to load it from RDBMS, marshal using protobuf, hash and do SMT search.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="off-chain-store">Off Chain Store<a href="#off-chain-store" class="hash-link" aria-label="Direct link to Off Chain Store" title="Direct link to Off Chain Store">​</a></h3><p>We were discussing use case where modules can use a support database, which is not automatically committed. Module will responsible for having a sound storage model and can optionally use the feature discussed in _<em>Committing to an object without saving it</em> section.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2><ul><li><a href="https://github.com/cosmos/cosmos-sdk/issues/7100" target="_blank" rel="noopener noreferrer">IAVL What&#x27;s Next?</a></li><li><a href="https://docs.google.com/document/d/16Z_hW2rSAmoyMENO-RlAhQjAG3mSNKsQueMnKpmcBv0/edit#heading=h.yd2th7x3o1iv" target="_blank" rel="noopener noreferrer">IAVL overview</a> of it&#x27;s state v0.15</li><li><a href="https://paper.dropbox.com/published/State-commitments-and-storage-review--BDvA1MLwRtOx55KRihJ5xxLbBw-KeEB7eOd11pNrZvVtqUgL3h" target="_blank" rel="noopener noreferrer">State commitments and storage report</a></li><li><a href="https://github.com/lazyledger/smt" target="_blank" rel="noopener noreferrer">Celestia (LazyLedger) SMT</a></li><li>Facebook Diem (Libra) SMT <a href="https://developers.diem.com/papers/jellyfish-merkle-tree/2021-01-14.pdf" target="_blank" rel="noopener noreferrer">design</a></li><li><a href="https://github.com/google/trillian/blob/master/docs/papers/RevocationTransparency.pdf" target="_blank" rel="noopener noreferrer">Trillian Revocation Transparency</a>, <a href="https://github.com/google/trillian/blob/master/docs/papers/VerifiableDataStructures.pdf" target="_blank" rel="noopener noreferrer">Trillian Verifiable Data Structures</a>.</li><li>Design and implementation <a href="https://github.com/cosmos/cosmos-sdk/discussions/8297" target="_blank" rel="noopener noreferrer">discussion</a>.</li><li><a href="https://github.com/cosmos/ibc-go/blob/main/docs/ibc/upgrades/quick-guide.md" target="_blank" rel="noopener noreferrer">How to Upgrade IBC Chains and their Clients</a></li><li><a href="https://github.com/cosmos/ibc-go/discussions/256" target="_blank" rel="noopener noreferrer">ADR-40 Effect on IBC</a></li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/v0.50/architecture/adr-039-epoched-staking"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">ADR 039: Epoched Staking</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/v0.50/architecture/adr-041-in-place-store-migrations"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">ADR 041: In-Place Store Migrations</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#changelog" class="table-of-contents__link toc-highlight">Changelog</a></li><li><a href="#status" class="table-of-contents__link toc-highlight">Status</a></li><li><a href="#abstract" class="table-of-contents__link toc-highlight">Abstract</a></li><li><a href="#context" class="table-of-contents__link toc-highlight">Context</a></li><li><a href="#decision" class="table-of-contents__link toc-highlight">Decision</a><ul><li><a href="#decouple-state-commitment-from-storage" class="table-of-contents__link toc-highlight">Decouple state commitment from storage</a></li><li><a href="#requirements" class="table-of-contents__link toc-highlight">Requirements</a></li><li><a href="#smt-for-state-commitment" class="table-of-contents__link toc-highlight">SMT for State Commitment</a></li><li><a href="#snapshots-for-storage-sync-and-state-versioning" class="table-of-contents__link toc-highlight">Snapshots for storage sync and state versioning</a></li><li><a href="#state-proofs" class="table-of-contents__link toc-highlight">State Proofs</a></li><li><a href="#rollbacks" class="table-of-contents__link toc-highlight">Rollbacks</a></li><li><a href="#committing-to-an-object-without-saving-it" class="table-of-contents__link toc-highlight">Committing to an object without saving it</a></li><li><a href="#refactor-multistore" class="table-of-contents__link toc-highlight">Refactor MultiStore</a></li><li><a href="#optimization-compress-module-key-prefixes" class="table-of-contents__link toc-highlight">Optimization: compress module key prefixes</a></li></ul></li><li><a href="#optimization-ss-key-compression" class="table-of-contents__link toc-highlight">Optimization: SS key compression</a></li><li><a href="#migration" class="table-of-contents__link toc-highlight">Migration</a></li><li><a href="#consequences" class="table-of-contents__link toc-highlight">Consequences</a><ul><li><a href="#backwards-compatibility" class="table-of-contents__link toc-highlight">Backwards Compatibility</a></li><li><a href="#positive" class="table-of-contents__link toc-highlight">Positive</a></li><li><a href="#negative" class="table-of-contents__link toc-highlight">Negative</a></li><li><a href="#neutral" class="table-of-contents__link toc-highlight">Neutral</a></li></ul></li><li><a href="#alternative-designs" class="table-of-contents__link toc-highlight">Alternative designs</a></li><li><a href="#further-discussions" class="table-of-contents__link toc-highlight">Further Discussions</a><ul><li><a href="#evaluated-kv-databases" class="table-of-contents__link toc-highlight">Evaluated KV Databases</a></li><li><a href="#rdbms" class="table-of-contents__link toc-highlight">RDBMS</a></li><li><a href="#off-chain-store" class="table-of-contents__link toc-highlight">Off Chain Store</a></li></ul></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cosmos.network"><img src="/img/logo-bw.svg" alt="Cosmos Logo"></a></li></ul></div><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://hub.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cosmos Hub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docs.cometbft.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">CometBFT<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ibc.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">IBC Go<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://blog.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forum.cosmos.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/cosmosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://reddit.com/r/cosmosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Reddit<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/cosmosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/cosmos" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/c/CosmosProject" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cosmosproject" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p>The development of the Cosmos SDK is led primarily by <a href="https://interchain.io/ecosystem">Interchain Core Teams</a>. Funding for this development comes primarily from the Interchain Foundation, a Swiss non-profit.</p></div></div></div></footer></div>
<script src="/assets/js/runtime~main.375ada2f.js"></script>
<script src="/assets/js/main.e8d6e5a5.js"></script>
</body>
</html>